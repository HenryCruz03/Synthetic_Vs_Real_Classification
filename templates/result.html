{% extends "base.html" %}

{% block content %}

<div class="result-container">

    <div class="result-header">
        <h2>üéØ Classification Result</h2>
        <p>AI Analysis Complete</p>
    </div>

    <div class="image-container">
        <img src="{{ url_for('uploaded_file', filename=filename) }}" alt="Uploaded Image" class="result-image"/>
    </div>

    <div class="result-box">
        <div class="prediction-section">
            <h3>Prediction</h3>
            <div class="prediction {{ 'synthetic' if 'ai-generated' in prediction.lower() or 'synthetic' in prediction.lower() else 'real' }}">
                {% if 'ai-generated' in prediction.lower() or 'synthetic' in prediction.lower() %}
                    ü§ñ AI-Generated Image
                {% else %}
                    üì∏ Real Image
                {% endif %}
            </div>
        </div>

        <div class="confidence-section">
            <h3>Confidence Level</h3>
            <div class="confidence-bar">
                <div class="confidence-fill" style="width: {{ (confidence * 100)|round(1) }}%"></div>
            </div>
            <p class="confidence-text">{{ (confidence * 100)|round(1) }}% confident</p>
        </div>

        <div class="explanation">
            {% if 'ai-generated' in prediction.lower() or 'synthetic' in prediction.lower() %}
                <p><strong>ü§ñ AI-Generated Image Detected</strong></p>
                <p>This image appears to be generated by AI or computer graphics. Look for telltale signs like perfect symmetry, unusual patterns, or artificial-looking details.</p>
            {% else %}
                <p><strong>üì∏ Real Image Detected</strong></p>
                <p>This image appears to be a genuine photograph. The AI found natural patterns and characteristics typical of real-world photography.</p>
            {% endif %}
        </div>
    </div>

    <!-- NEW: Generated Images Section (Always shown if images exist) -->
    {% if generated_images and generated_images|length > 0 %}
    <div class="enhancement-section">
        <div class="enhancement-header">
            <h3>üé® Generated Similar Images</h3>
            <p>AI generated {{ generated_images|length }} similar images for training data enhancement</p>
        </div>

        <div class="enhancement-details">
            <div class="generated-images">
                <h4>Generated Images</h4>
                <div class="image-grid">
                    {% for img in generated_images %}
                    <div class="generated-image-item">
                        <img src="{{ url_for('uploaded_file', filename=img) }}" alt="Generated Image" class="generated-image"/>
                        <div class="image-label">
                            <span class="label {{ 'synthetic' if 'ai-generated' in prediction.lower() else 'real' }}">
                                {{ prediction }}
                            </span>
                            <button onclick="curateImage('{{ img }}', '{{ prediction }}', this)" class="btn btn-sm btn-primary">
                                üì§ Upload for Training
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if confidence < 0.6 %}
    <div class="enhancement-section">
        <div class="enhancement-header">
            <h3>üîß Low Confidence Enhancement</h3>
            <p>Confidence below 60% - Agent generated similar images for training data curation</p>
        </div>

        <div class="enhancement-details">
            <div class="enhancement-info">
                <h4>üìä Enhancement Summary</h4>
                <p><strong>Reason:</strong> Confidence below threshold (0.6): {{ (confidence * 100)|round(1) }}%</p>
                <p><strong>Generated Images:</strong> {{ enhancement_data.total_generated if enhancement_data else 0 }}</p>
                <p><strong>Real Images Fetched:</strong> {{ enhancement_data.total_real if enhancement_data else 0 }}</p>
            </div>

            {% if enhancement_data and enhancement_data.recommendation %}
            <div class="recommendation">
                <h4>üí° Training Data Recommendation</h4>
                <p>{{ enhancement_data.recommendation }}</p>
            </div>
            {% endif %}

            {% if enhancement_data and enhancement_data.generated_images %}
            <div class="generated-images">
                <h4>üé® Generated Similar Images</h4>
                <div class="image-grid">
                    {% for img in enhancement_data.generated_images %}
                    <div class="generated-image-item">
                        <img src="{{ url_for('uploaded_file', filename=img.image_path.split('/')[-1]) }}" alt="Generated Image" class="generated-image"/>
                        <div class="image-label">
                            <span class="label {{ 'synthetic' if 'ai-generated' in img.label.lower() else 'real' }}">
                                {{ img.label }}
                            </span>
                            <span class="confidence">{{ (img.confidence * 100)|round(1) }}%</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="curation-actions">
                <h4>üìã Training Data Curation</h4>
                <p>Review the generated images above and decide which ones to add to your training dataset:</p>
                <div class="curation-buttons">
                    <button onclick="curateTrainingData('accept_all')" class="btn btn-success">
                        ‚úÖ Accept All Generated Images
                    </button>
                    <button onclick="curateTrainingData('reject_all')" class="btn btn-danger">
                        ‚ùå Reject All Generated Images
                    </button>
                    <button onclick="showSelectiveCuration()" class="btn btn-warning">
                        üéØ Selective Curation
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="action-buttons">
        <a href="{{ url_for('index') }}" class="btn btn-primary">
            üîÑ Classify Another Image
        </a>
        <button onclick="window.history.back()" class="btn btn-secondary">
            ‚Üê Go Back
        </button>
    </div>

    <div class="tips">
        <h4>üí° Tips for Better Results</h4>
        <ul>
            <li>Use high-quality images for more accurate results</li>
            <li>Try different angles or lighting conditions</li>
            <li>Recent AI-generated images may be harder to detect</li>
        </ul>
    </div>

</div>

<!-- Selective Curation Modal -->
<div id="selectiveCurationModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üéØ Selective Image Curation</h3>
            <span class="close" onclick="closeSelectiveModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="selection-instructions">
                <p>Review the generated images below and select which ones you'd like to add to your training dataset:</p>
                <div id="selectionSummary" class="selection-summary">0 image(s) selected</div>
            </div>
            <div id="imageSelectionGrid" class="image-selection-grid">
                <!-- Images will be loaded here dynamically -->
            </div>
        </div>
        <div class="modal-footer">
            <button onclick="closeSelectiveModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="submitSelectiveCuration()" class="btn btn-primary">Add Selected Images to Training Data</button>
        </div>
    </div>
</div>

<script>
// NEW: Add curate image function
function curateImage(filename, label, buttonElement) {
    buttonElement.disabled = true;
    buttonElement.textContent = '‚è≥ Uploading...';

    fetch('/curate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            filename: filename,
            label: label
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            buttonElement.textContent = '‚úì Uploaded';
            buttonElement.classList.add('btn-success');
            buttonElement.classList.remove('btn-primary');
        } else {
            buttonElement.textContent = '‚úó Failed';
            buttonElement.classList.add('btn-danger');
            buttonElement.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        buttonElement.textContent = '‚úó Error';
        buttonElement.classList.add('btn-danger');
        buttonElement.disabled = false;
    });
}

function curateTrainingData(action) {
    const data = {
        action: action,
        image_id: "{{ filename }}"
    };

    fetch('/training-curation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(data.message);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your request.');
    });
}

function showSelectiveCuration() {
    const modal = document.getElementById('selectiveCurationModal');
    if (modal) {
        modal.style.display = 'block';
        loadImagesForSelection();
        modal.onclick = function(event) {
            if (event.target === modal) {
                closeSelectiveModal();
            }
        }
    }
}

function closeSelectiveModal() {
    const modal = document.getElementById('selectiveCurationModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function loadImagesForSelection() {
    const imageGrid = document.getElementById('imageSelectionGrid');
    if (!imageGrid) return;

    imageGrid.innerHTML = '';

    const enhancementSection = document.querySelector('.enhancement-section');
    if (!enhancementSection) {
        imageGrid.innerHTML = '<p>No generated images available for selection.</p>';
        return;
    }

    const generatedImagesContainer = enhancementSection.querySelector('.generated-images');
    if (!generatedImagesContainer) {
        imageGrid.innerHTML = '<p>No generated images found in enhancement data.</p>';
        return;
    }

    const imageItems = generatedImagesContainer.querySelectorAll('.generated-image-item');
    if (imageItems.length === 0) {
        imageGrid.innerHTML = '<p>No images available for selection.</p>';
        return;
    }

    imageItems.forEach((imgContainer, index) => {
        const img = imgContainer.querySelector('.generated-image');
        const labelElement = imgContainer.querySelector('.label');
        const confidenceElement = imgContainer.querySelector('.confidence');

        const label = labelElement ? labelElement.textContent : 'Unknown';
        const confidence = confidenceElement ? confidenceElement.textContent : '0%';

        if (img && img.src) {
            const imageItem = document.createElement('div');
            imageItem.className = 'selectable-image-item';
            imageItem.innerHTML = `
                <div class="image-container">
                    <img src="${img.src}" alt="Generated Image ${index + 1}" class="selectable-image">
                    <div class="image-overlay">
                        <input type="checkbox" id="select_${index}" class="image-checkbox" onchange="toggleImageSelection(${index})">
                        <label for="select_${index}" class="checkbox-label">Select</label>
                    </div>
                </div>
                <div class="image-info">
                    <span class="image-label ${label.toLowerCase().includes('ai-generated') ? 'synthetic' : 'real'}">${label}</span>
                    <span class="image-confidence">${confidence}</span>
                </div>
            `;
            imageGrid.appendChild(imageItem);
        }
    });

    updateSelectionSummary();
}

function toggleImageSelection(index) {
    const checkbox = document.getElementById(`select_${index}`);
    const imageItem = checkbox.closest('.selectable-image-item');
    if (checkbox.checked) {
        imageItem.classList.add('selected');
    } else {
        imageItem.classList.remove('selected');
    }
    updateSelectionSummary();
}

function updateSelectionSummary() {
    const selectedCheckboxes = document.querySelectorAll('.image-checkbox:checked');
    const summary = document.getElementById('selectionSummary');
    if (summary) {
        summary.textContent = `${selectedCheckboxes.length} image(s) selected`;
    }
}

function submitSelectiveCuration() {
    const selectedCheckboxes = document.querySelectorAll('.image-checkbox:checked');
    const selectedImages = Array.from(selectedCheckboxes).map(checkbox => {
        const imageItem = checkbox.closest('.selectable-image-item');
        const img = imageItem.querySelector('.selectable-image');
        return {
            index: checkbox.id.split('_')[1],
            src: img.src,
            filename: img.src.split('/').pop()
        };
    });

    if (selectedImages.length === 0) {
        alert('Please select at least one image to add to training data.');
        return;
    }

    const data = {
        action: 'selective',
        selected_images: selectedImages,
        image_id: "{{ filename }}"
    };

    fetch('/training-curation', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(data.message);
            closeSelectiveModal();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing your request.');
    });
}
</script>

{% endblock %}